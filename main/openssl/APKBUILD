# Maintainer: Damir Holovati
pkgname=openssl
pkgver=3.5.2
_abiver=${pkgver%.*.*}
pkgrel=0
pkgdesc="Toolkit for Transport Layer Security (TLS)"
url="https://www.openssl.org/"
arch="all"
license="Apache-2.0"
provider_priority=100  # highest
options="!check"
makedepends_build="perl"
makedepends="$makedepends_host $makedepends_build"
subpackages="
	$pkgname-libs-static
	$pkgname-dev
	"
source="https://github.com/openssl/openssl/releases/download/openssl-$pkgver/openssl-$pkgver.tar.gz
	man-section.patch
	"
builddir="$srcdir/openssl-$pkgver"

build() {

	perl ./Configure \
		--prefix=/usr \
		--libdir=lib \
		--openssldir=/etc/ssl \
		hurd-generic64 \
		enable-ktls \
		shared \
		no-zlib \
		no-async \
		no-comp \
		no-idea \
		no-mdc2 \
		no-rc5 \
		no-ec2m \
		no-ssl3 \
		no-seed \
		no-tests \
		no-docs \
		no-weak-ssl-ciphers \
		$CPPFLAGS \
		$CFLAGS -pipe \
		$LDFLAGS

	# dump configuration into logs
	perl configdata.pm --dump

	make
}

# We can't build them yet, runs the kernel out of memory
#check() {
#	# AFALG tests have a sporadic test failure, just delete the broken
#	# test for now.
#	rm -f test/recipes/30-test_afalg.t
#
#	make test
#}

package() {
	depends="libssl$_abiver=$pkgver-r$pkgrel libcrypto$_abiver=$pkgver-r$pkgrel"
	provides="openssl3=$pkgver-r$pkgrel"
	replaces="openssl3"

	make DESTDIR="$pkgdir" install_sw
	
	#remove the script c_rehash
	rm "$pkgdir"/usr/bin/c_rehash
}

dev() {
	provides="openssl3-dev=$pkgver-r$pkgrel"
	replaces="openssl3-dev"

	default_dev
}

misc() {
	depends="$pkgname=$pkgver-r$pkgrel perl"
	pkgdesc="Various perl scripts from $pkgname"

	amove etc/ssl/misc
}

_libcrypto() {
	pkgdesc="Crypto library from openssl"

	amove etc
	amove usr/lib/libcrypto*
	amove usr/lib/engines-$_abiver
	amove usr/lib/ossl-modules
}

_libssl() {
	pkgdesc="SSL shared libraries"
	depends="libcrypto$_abiver=$pkgver-r$pkgrel"

	amove usr/lib/libssl*
}

sha512sums="
db2c7a88bea432f96d867a98af15f850f371d4136c657338de93cb88a39a3578c025b5df7310e195a02fc715ad5a2422a319a44f0247c6a7e2ba8b36aad77651  openssl-3.5.2.tar.gz
8c44e990fe8a820f649631b9f81cf28225b7516065169a7f68e2dd7c067b30df9b2c6cb88fa826afbc9fcdaf156360aabf7c498d2d9ed452968815b12b004809  man-section.patch
"
