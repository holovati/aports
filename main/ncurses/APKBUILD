# Maintainer: Damir Holovati
pkgname=ncurses
pkgver=6.5_p20250816
_pkgver=${pkgver/_p/-}
pkgrel=0
pkgdesc="Console display library"
url="https://invisible-island.net/ncurses/"
arch="all"
options="!check" # "tests" are actual demo programs, not a test suite.
license="X11"
makedepends_build="ncurses"
subpackages="
	$pkgname-static
	$pkgname-dev
	$pkgname-doc
	$pkgname-terminfo:terminfo:noarch
	libformw
	libmenuw
	libncurses++:pp
	libncursesw
	libpanelw
	"
source="https://invisible-mirror.net/archives/ncurses/current/ncurses-$_pkgver.tgz
	cleanup-pkgconfig-ldflags.patch
	"
builddir="$srcdir/$pkgname-$_pkgver"

# Terminfo definitions to be included in ncurses-terminfo-base.
_basic_terms="
	alacritty
	ansi
	console
	dumb
	gnome
	gnome-256color
	konsole
	konsole-256color
	konsole-linux
	linux
	putty
	putty-256color
	rxvt
	rxvt-256color
	screen
	screen-256color
	st-*
	sun
	terminator
	terminology*
	tmux
	tmux-256color
	vt100
	vt102
	vt200
	vt220
	vt52
	vte
	vte-256color
	xterm
	xterm-256color
	xterm-color
	xterm-xfree86
	"

prepare() {
	default_prepare
	update_config_sub
	update_config_guess
	
	# We won't be able to build shared libraries unless we add emerixx to the supoorted os test
	sed -i 's/k\*bsd\*-gnu/emerixx*|k*bsd*-gnu/g' configure
}

build() {
	CFLAGS="$CFLAGS -pipe" \
	CXXFLAGS="$CFLAGS -pipe" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--mandir=/usr/share/man \
		--without-ada \
		--without-tests \
		--disable-termcap \
		--disable-rpath-hack \
		--disable-setuid-environ \
		--disable-stripping \
		--with-pkg-config-libdir=/usr/lib/pkgconfig \
		--with-cxx-binding \
		--with-cxx-shared \
		--with-terminfo-dirs="/usr/share/terminfo:/lib/terminfo:/usr/lib/terminfo:/etc/terminfo" \
		--enable-pc-files \
		--enable-symlinks \
		--with-shared \
		--enable-widec
	make
}

package() {
	make DESTDIR="$pkgdir" install

	cd "$pkgdir"

	# force link against *w.so
	local lib; for lib in ncurses ncurses++ form panel menu; do
		ln -s ${lib}w.pc usr/lib/pkgconfig/$lib.pc
		ln -s lib${lib}w.a usr/lib/lib$lib.a
		ln -s lib${lib}w.so usr/lib/lib$lib.so
	done

	# link curses, tic, tinfo -> ncurses
	for lib in curses tic tinfo; do
		ln -s libncurses.a usr/lib/lib${lib}.a
		ln -s libncurses.so usr/lib/lib${lib}.so
		ln -s ncurses.pc usr/lib/pkgconfig/${lib}.pc
	done
	ln -s libncursesw.so usr/lib/libcursesw.so
}

terminfo() {
	pkgdesc="$pkgdesc (other terminfo files)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/share/terminfo
	# also move symlink
	amove usr/lib/terminfo
}

libmenuw() {
	pkgdesc="$pkgdesc ($subpkgname)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/lib/libmenuw.so.*
}

libformw() {
	pkgdesc="$pkgdesc ($subpkgname)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/lib/libformw.so.*
}

pp() {
	pkgdesc="$pkgdesc ($subpkgname)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/lib/libncurses++w.so.*
}

libncursesw() {
	pkgdesc="$pkgdesc ($subpkgname)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/lib/libncursesw.so.*
}

libpanelw() {
	pkgdesc="$pkgdesc ($subpkgname)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	amove usr/lib/libpanelw.so.*
}

sha512sums="
310b6e85dfc7500486bd252c8f495ef4df7fc15e175e358014bf8b654f596692d0151a37d189e09064e7bd90756e4b438d2e82e9fd24b28db528c94350cc0365  ncurses-6.5-20250816.tgz
201ef1876655101cedabc83a0ce46f75079b08f565ca8de4cf96fd69e41332a2d0597b77fe360dc58b10772586fa39bd52ac9ee670a912fef84840278356065a  cleanup-pkgconfig-ldflags.patch
"
