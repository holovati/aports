# Maintainer: Damir Holovati
pkgname=perl
pkgver=5.42.0
pkgrel=0
pkgdesc="Larry Wall's Practical Extraction and Report Language"
url="https://www.perl.org/"
arch="all"
license="Artistic-1.0-Perl OR GPL-1.0-or-later"
depends_dev="perl-utils=$pkgver-r$pkgrel"
makedepends_host="bzip2-dev zlib-dev"
subpackages="$pkgname-doc $pkgname-dev $pkgname-utils::noarch"

source="https://www.cpan.org/src/5.0/perl-$pkgver.tar.xz
	digest-sha-cflags.patch
	dont-write-packlist.patch
	json-pp-options.patch
	musl-skip-dst-test.patch
	musl-stack-size.patch
	skip-test-due-to-busybox-ps.patch
	encode-no-ucm.patch
	config.sh
	"

# creates empty usr/local/{lib,share} for local sitedirs
options="!fhs"

# in perl core, removed from main/perl-scalar-list-utils
provides="
	perl-scalar-list-utils=$pkgver-r$pkgrel
	"
prepare() {
	# most sources are readonly but we patch some
	chmod +w "$builddir"/*.c
	default_prepare

	# Ensure that we never accidentally bundle zlib or bzip2
	rm -rf cpan/Compress-Raw-Zlib/zlib-src
	rm -rf cpan/Compress-Raw-Bzip2/bzip2-src
	sed -i '/\(bzip2\|zlib\)-src/d' MANIFEST

	cp ../../config.sh config.sh
}

build() {
	export BUILD_ZLIB=0
	export BUILD_BZIP2=0
	export BZIP2_LIB="$CBUILDROOT/usr/lib"
	export BZIP2_INCLUDE="$CBUILDROOT/usr/include"

	# language runtime
	CFLAGS="$CFLAGS -pipe"

	sh Configure -desS \
		-D prefix=/usr \
		-D vendorprefix=/usr \
		-D privlib=/usr/lib/perl5/5.42/core_perl \
		-D archlib=/usr/lib/perl5/5.42/core_perl \
		-D sitelib=/usr/lib/perl5/5.42/site_perl \
		-D sitearch=/usr/lib/perl5/5.42/site_perl \
		-D vendorlib=/usr/lib/perl5/5.42/vendor_perl \
		-D vendorlib=/usr/lib/perl5/5.42/vendor_perl \
		-D man1dir=/usr/share/man/man1 \
		-D man3dir=/usr/share/man/man3 \
		-D pager="/usr/bin/less -isR"

	#sed -i "s/d_eaccess='define'/d_eaccess='undef'/g" config.sh
	#sed -i "s/i_sysaccess='undef'/i_sysaccess='define'/g" config.sh

	make PERL_CORE=1 PERL5LIB="./lib"
}

check() {
	export CI=true
	export LC_ALL=C

	# Perl tests HARNESS_OPTIONS against the regex
	# /^j(\d*)$/, if $JOBS is unset, it defaults to 9
	export HARNESS_OPTIONS=j"$JOBS"
	export PERL_TEST_HARNESS_ASAP=1

	make test_harness_notty
}

package() {
	make DESTDIR="$pkgdir" install.perl

	if subpackages_has "$pkgname-doc"; then
		make install.man \
			DESTDIR="$pkgdir" \
			INSTALLFLAGS="--man3ext=3pm"
	fi
}

doc() {
	local file; find "$pkgdir" -name "*.pod" | while read -r file; do
		amove "${file#"$pkgdir"}"
	done
	default_doc
}

dev() {
	amove usr/bin/h2xs \
		usr/bin/perlivp \
		usr/bin/enc2xs \
		usr/bin/xsubpp

	default_dev
}

utils() {
	pkgdesc="$pkgdesc (misc utilities)"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove \
		usr/bin/corelist \
		usr/bin/cpan \
		usr/bin/encguess \
		usr/bin/libnetcfg \
		usr/bin/h2ph \
		usr/bin/instmodsh \
		usr/bin/json_pp \
		usr/bin/perlbug \
		usr/bin/perlthanks \
		usr/bin/piconv \
		usr/bin/pl2pm \
		usr/bin/prove \
		usr/bin/ptar \
		usr/bin/ptardiff \
		usr/bin/ptargrep \
		usr/bin/shasum \
		usr/bin/splain \
		usr/bin/zipdetails
}

sha512sums="
b10f74d1245a879ae51d3ad93ad519a148df126ec865715474c801548ccfc3f542ef3bbb1f59568cea2ec77302d428dc772aba605357d7faf13eb6a351917275  perl-5.42.0.tar.xz
59afa4c166e4808d355e19cd70748540ffce9da5c6919c71648be7678de328409f9121ddea33415add73fc01a22e95ed9d9629f31b8ba20b3bbfc04dab926c63  digest-sha-cflags.patch
abae709290306a8fbc96b604b9b38fc09a46ae178f3e77944813f1b46c78e2e3654e5c3b3a6aca96684a2d1061e2871376d508fbe82604864055309156b4d0d8  dont-write-packlist.patch
4e8a655160e54a151e0bc4819fd1cd69e43c1e36844bcefbb9734f36130a2d9e1700b1aa64153a9d20a8deb875e904876dbe7b14dd278266b21a86a33d91eebd  json-pp-options.patch
cd5bc95a526b0803d80b7d201ad36b347cca04451aff124e0297e8514f9cbdc87c3ce37dadf41ccb72d0e77ac82d7831e165a8d4f21f36be8a9a60872a0d6f14  musl-skip-dst-test.patch
c004d6612ec754e5947255a2e2d15b5581f187c32495aeeec9f4fa286919bd9f40c72b63db61e3f4004b09288af2063a6a14b67e5c289e9a8b23ebd7c216e16f  musl-stack-size.patch
7d8d19d295ad740f4aa43d68cb86726c8781940c624bff825811b9874438e3621befa7f24774d98fa8667349a05047c48119cc080977b232e48964aabe5aa93a  skip-test-due-to-busybox-ps.patch
99ac9d3dd5a01269b4575a01bccaca3227ad2cd63ef2e075dfc820ad923ce6f4a41187b7cec9f92dc5adc1dcf56d198bec7962e0ac6f74c43529c93e3433fc15  encode-no-ucm.patch
e84a06df0b16242ed2edcb9f13a0238494764f0695b492c6ab7e289e26607c00f701e7cbd18a75a1a51277aa5b160ae9a856219a7249f135aa8dca9a3b77cb44  config.sh
"
