# Maintainer: Damir Holovati

pkgname=curl
pkgver=8.15.0
pkgrel=0
pkgdesc="URL retrival utility and library"
url="https://curl.se/"
arch="all"
license="curl"
depends="ca-certificates"

depends_dev="
	ca-certificates
	openssl-dev>3
	zlib-dev
	zstd-dev
	"
checkdepends="nghttp2 python3"

makedepends_host="$depends_dev"

makedepends_build="groff perl"

subpackages="$pkgname-static $pkgname-doc $pkgname-dev libcurl"

source="https://curl.se/download/curl-$pkgver.tar.xz"

options="net" # Required for running tests

prepare() {
	default_prepare
	update_config_sub
	update_config_guess
	update_configure
}

build() {
	CFLAGS="$CFLAGS -pipe" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-ipv6 \
		--enable-unix-sockets \
		--enable-static \
		--with-zlib \
		--with-zstd \
		--with-openssl \
		--with-ca-bundle=/etc/ssl/certs/ca-bundle.crt \
		--with-ca-path=/etc/ssl/certs \
		--disable-ldap \
		--disable-ldaps \
		--disable-rtsp \
		--disable-dict \
		--disable-telnet \
		--disable-smb \
		--disable-mqtt \
		--without-libpsl \
		--without-nghttp2 \
		--without-brotli \
		--without-libssh2 # https://bugs.alpinelinux.org/issues/10222
	make

}

check() {
	make -C tests
	make -j1 -C tests nonflaky-test
}

package() {
	# depends on exactly the same build of libcurl
	depends="libcurl=$pkgver-r$pkgrel"
	
	mkdir -pv "$pkgdir/etc" || true

	install -m644 "../../curlrc" "$pkgdir/etc/curlrc"

	make install DESTDIR="$pkgdir"	
}

libcurl() {
	pkgdesc="The multiprotocol file transfer library"
	amove usr/lib
}

dev() {
	default_dev
	# Used by trurl
	install -Dm755 -t "$subpkgdir"/usr/bin "$builddir"/scripts/cd2nroff
}

sha512sums="
d27e316d70973906ac4b8d2c280f7e99b7528966aa1220c13a38ed45fca2ed6bbde54b8a9d7bed9e283171b92edb621f7b95162ef7d392e6383b0ee469de3191  curl-8.15.0.tar.xz
"
